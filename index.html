<!DOCTYPE html>
<html>
<head>
    <title>QR Code Page</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin: 0;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>
    <br><br><br>
    <h1>Scan This QR Code to Pay</h1>
    <h2>Amount to be paid: Rs.<span id="amount">—</span></h2>
    <img src="qr.png" alt="QR Code" width="250">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

    <script>
        // ========= 1st Firebase for price fetching =========
        const firebaseConfigPrice = {
            apiKey: "AIzaSyBWocGhLMcWTHNgS8pW2Y-jV1r5s-2pd6M",
            authDomain: "entry-gate-ddc57.firebaseapp.com",
            databaseURL: "https://entry-gate-ddc57-default-rtdb.firebaseio.com/",
            projectId: "entry-gate-ddc57",
            storageBucket: "entry-gate-ddc57.appspot.com"
        };

        // ========= 3rd Firebase for storing history & payment =========
        const firebaseConfigHistory = {
            apiKey: "AIzaSyBpRla6iYXgZuxyCHvtQ8bIcwKf5i3ga1U",
            authDomain: "history-storing.firebaseapp.com",
            databaseURL: "https://history-storing-default-rtdb.firebaseio.com",
            projectId: "history-storing",
            storageBucket: "history-storing.firebasestorage.app",
            messagingSenderId: "30155724407",
            appId: "1:30155724407:web:0162dd94f5492441ae9872"
        };

        // ====== Initialize Firebase apps separately ======
        const appPrice = firebase.initializeApp(firebaseConfigPrice, "priceApp");
        const appHistory = firebase.initializeApp(firebaseConfigHistory, "historyApp");

        const dbPrice = firebase.database(appPrice);
        const dbHistory = firebase.database(appHistory);

        // ====== Ask for vehicle number and fetch price ======
        const vehicleNumber = prompt("Enter your Vehicle Number:");
        let currentRecordRef = null; // will store path to this user’s record

        function findPrice(snapshot) {
            let found = false;
            const data = snapshot.val();
            for (let slot in data) {
                for (let recordId in data[slot]) {
                    let record = data[slot][recordId];
                    if (record.vehicleNo && record.vehicleNo.toLowerCase() === vehicleNumber.toLowerCase()) {
                        document.getElementById('amount').textContent = record.price;

                        // ====== Store history in 3rd DB with paymentComplete=false ======
                        currentRecordRef = dbHistory.ref("vehicleLogs").push({
                            vehicleNo: vehicleNumber,
                            price: record.price,
                            paymentComplete: false
                        });

                        // ====== Listen for payment completion in THIS record ======
                        currentRecordRef.on("value", (snap) => {
                            if (snap.val() && snap.val().paymentComplete === true) {
                                window.location.href = 'indexing.html';
                            }
                        });

                        found = true;
                        break;
                    }
                }
                if (found) break;
            }
            if (!found) {
                document.getElementById('amount').textContent = "Not found";
            }
        }
        dbPrice.ref("slots").once("value", findPrice);
    </script>
</body>
</html>
